Understood.
I‚Äôll do this properly, calmly, and technically, like a real KT where teammates can open the code and follow line-by-line.

I will:
	‚Ä¢	Start from request ‚Üí return
	‚Ä¢	Explain code line-by-line (block-by-block where lines repeat obvious imports)
	‚Ä¢	Show dummy input & output at EVERY stage
	‚Ä¢	Explain WHY each line exists
	‚Ä¢	Tie every function back into the flow

No storytelling. No summaries. Pure code KT.

‚∏ª

üî¥ MASTER FLOW (KEEP THIS IN MIND)

HTTP Request
  ‚Üì
router.py
  ‚Üì
summary_handler.summarize_blob_pdfs_layout()
  ‚Üì
Blob Download
  ‚Üì
OCR (Form Recognizer)
  ‚Üì
Short Summary (LLM)
  ‚Üì
Save JSON
  ‚Üì
Extract + Beautify
  ‚Üì
Download Email Body
  ‚Üì
Combined Summary (LLM)
  ‚Üì
Individual Doc Summary (LLM)
  ‚Üì
Clean + Beautify
  ‚Üì
HTTP Response


‚∏ª

1Ô∏è‚É£ router.py ‚Äî REQUEST ENTRY

router = APIRouter()

‚û° Creates FastAPI router object.

‚∏ª


class AttachmentSummaryRequest(BaseModel):

‚û° Pydantic model for request validation.

attachment_urls: List[str]

‚û° Ensures request MUST contain list of blob URLs.

‚úÖ Dummy Input (HTTP)

{
  "attachment_urls": [
    "https://acc.blob.core.windows.net/docs/12345_ACORD.pdf"
  ]
}


‚∏ª


@router.post("/attachment_summary_mcp")

‚û° HTTP endpoint registration.

‚∏ª


async def document_summarizer(request: AttachmentSummaryRequest):

‚û° Entry function executed on API call.

‚∏ª


result = await summarize_blob_pdfs_layout(request.attachment_urls)

‚û° CONTROL TRANSFERS HERE

‚∏ª

2Ô∏è‚É£ summary_handler.py ‚Äî MAIN ORCHESTRATOR

async def summarize_blob_pdfs_layout(blob_urls: List[str])

‚û° Receives list of Azure Blob URLs.

Dummy Input

[
 "https://acc.blob.core.windows.net/docs/12345_ACORD.pdf"
]


‚∏ª

üîπ ENV CHECK

summary_require_env()

üìÅ summary_service.py

if not AZURE_STORAGE_CONNECTION_STRING:
    raise RuntimeError

‚û° Stops system if Azure Storage is misconfigured.

‚∏ª

üîπ LOOP OVER FILES

for blob_url in blob_urls:

‚û° Process each attachment independently.

‚∏ª

üîπ DOWNLOAD PDF

local_pdf = await download_blob_to_input_folder(blob_url)

üìÅ summary_storage_utils.py

‚∏ª

download_blob_to_input_folder ‚Äî LINE BY LINE

container, blob_path = _parse_blob_url(blob_url)

‚û° Extracts:

container = "docs"
blob_path = "12345_ACORD.pdf"


‚∏ª


filename = os.path.basename(blob_path)

‚û° "12345_ACORD.pdf"

‚∏ª


local_path = os.path.join("input", filename)

‚û° "input/12345_ACORD.pdf"

‚∏ª


stream = await blob_client.download_blob()
data = await stream.readall()

‚û° Downloads file bytes.

‚∏ª


await f.write(data)

‚û° Writes PDF locally.

‚úÖ Output

input/12345_ACORD.pdf


‚∏ª

üîπ OCR / TEXT EXTRACTION

document_content = load_summary_document(local_pdf)

üìÅ summary_loader.py

‚∏ª

load_summary_document ‚Äî LINE BY LINE

poller = client.begin_analyze_document("prebuilt-read", document=f)

‚û° Azure OCR call.

‚∏ª


for page in result.pages:

‚û° Loops through ALL PAGES.

‚∏ª


page_lines = [line.content for line in page.lines]

‚û° Extracts visible text.

‚∏ª


all_pages_text = "\n\n".join(all_pages_text_list)

‚û° Combines full document.

‚∏ª


return {
  "first_page_text": all_pages_text
}

‚ö† Misnamed but intentional.

‚úÖ Output

{
 "first_page_text": "Named Insured: ABC Ltd\nCoverage: Property..."
}


‚∏ª

üîπ SHORT SUMMARY (LLM)

summary_text = summarize_first_page(document_content)

üìÅ summary_classifier.py

‚∏ª

summarize_first_page ‚Äî LINE BY LINE

first_page_text = document_content.get("first_page_text")


‚∏ª


first_page_text = first_page_text[:4000]

‚û° Token safety.

‚∏ª


response = client.chat.completions.create(...)

‚û° Azure OpenAI call.

‚∏ª


return response.choices[0].message.content.strip()

‚úÖ Output

"ABC Ltd is seeking property insurance coverage..."


‚∏ª

üîπ BUILD RAW RESULT

summaries.append({
 "file_name": file_name,
 "summary": summary_text,
 "text": text_content
})


‚∏ª

üîπ SAVE JSON

json.dump(result, "output/layout_summaries_result.json")

Saved File

{
 "summaries": [
   {
     "file_name": "12345_ACORD.pdf",
     "summary": "...",
     "text": "FULL OCR TEXT"
   }
 ]
}


‚∏ª

3Ô∏è‚É£ Data_Filler.py ‚Äî EXTRACTION & REFERENCE

‚∏ª

extract_filenames_and_summaries

with open("layout_summaries_result.json")

‚û° Reads saved file.

‚∏ª


data.get("summaries", [])

‚û° Gets document list.

‚∏ª


return [
  {
    "file_name": item["file_name"],
    "summary": item["summary"],
    "text": item["text"]
  }
]

‚úÖ Output

[
 {
  "file_name": "12345_ACORD.pdf",
  "summary": "...",
  "text": "..."
 }
]


‚∏ª

beautify_extracted_data

reference_number = file_name.split("_")[0]

‚û° "12345"

‚∏ª


beautified_item = {
 "reference_number": "12345",
 "file_name": "...",
 "summary": "..."
}

‚úÖ Output

[
 {
  "reference_number": "12345",
  "file_name": "12345_ACORD.pdf",
  "summary": "..."
 }
]


‚∏ª

4Ô∏è‚É£ EMAIL BODY DOWNLOAD

download_blob_to_input_folder_by_reference(beautify_data)

üìÅ summary_storage_utils.py

‚∏ª

LINE BY LINE

blob_name = f"body_{ref}.txt"


‚∏ª


await blob_client.download_blob()


‚∏ª


email_body/body_12345.txt


‚∏ª

5Ô∏è‚É£ COMBINED SUMMARY ‚Äî newsummary.py

‚∏ª

summarize_attachments

for item in attachments:


‚∏ª


attachment_chunks.append(
 f"FILENAME:{file_name}\nSUMMARY:{summary}"
)


‚∏ª


email_bodies = load_raw_email_bodies_for_refs(refs)


‚∏ª


prompt = f"""You are an underwriter..."""


‚∏ª


client.chat.completions.create(...)

‚úÖ Output

SUBMISSION SUMMARY
Client: ABC Ltd
Submission Type: New Business
Loss History: Not Present


‚∏ª

6Ô∏è‚É£ INDIVIDUAL SUMMARY ‚Äî separate_summary.py

‚∏ª

identify_document_type

raw = _call_chat_llm(prompt)


‚∏ª


if raw.upper() == "ACORD":

Output

"ACORD"


‚∏ª

process_acord / process_loss_run / process_sov

text = text[:4000]


‚∏ª


_call_chat_llm(prompt)


‚∏ª

Output

LOSS HISTORY PACKAGE...


‚∏ª

individual_summary

attachment["document_type"] = document_type
attachment["processed_summary"] = processed_summary


‚∏ª

7Ô∏è‚É£ CLEAN RESPONSE

clean_result_for_api(result)


‚∏ª


return {
 "combined_summary": "...",
 "individualized_summary": [...]
}


‚∏ª

8Ô∏è‚É£ FINAL API RESPONSE

Returned to router ‚Üí HTTP response.

‚∏ª

üß† FINAL KT ONE-LINE

‚ÄúThe handler controls the full lifecycle: download ‚Üí OCR ‚Üí short summary ‚Üí combined underwriting summary ‚Üí individual document analysis ‚Üí cleanup ‚Üí response.‚Äù

‚∏ª

If you want next:
	‚Ä¢	Literal comment-by-comment annotated code
	‚Ä¢	Refactor into clean architecture
	‚Ä¢	Remove duplication
	‚Ä¢	Fix naming issues

Say what you want and I‚Äôll do only that.
