from dotenv import load_dotenv
import os
import json
from Data_Filler import extract_filenames_and_summaries
from Data_Filler import connect_to_blob, beautify_extracted_data
from openai import AzureOpenAI  # Correct import for Azure OpenAI

# Load environment variables
load_dotenv()

AZURE_OPENAI_ENDPOINT = os.getenv("AZURE_OPENAI_ENDPOINT")
AZURE_OPENAI_API_VERSION = os.getenv("AZURE_OPENAI_API_VERSION")
AZURE_OPENAI_API_KEY = os.getenv("AZURE_OPENAI_API_KEY")
AZURE_OPENAI_CHAT_DEPLOYMENT = os.getenv("AZURE_OPENAI_CHAT_DEPLOYMENT")

if not (
    AZURE_OPENAI_ENDPOINT
    and AZURE_OPENAI_API_VERSION
    and AZURE_OPENAI_API_KEY
    and AZURE_OPENAI_CHAT_DEPLOYMENT
):
    raise RuntimeError(
        "Azure OpenAI env vars missing. Please set "
        "AZURE_OPENAI_ENDPOINT, AZURE_OPENAI_API_VERSION, "
        "AZURE_OPENAI_API_KEY and AZURE_OPENAI_CHAT_DEPLOYMENT"
    )

# Create Azure OpenAI client
client = AzureOpenAI(
    api_key=AZURE_OPENAI_API_KEY,
    api_version=AZURE_OPENAI_API_VERSION,
    azure_endpoint=AZURE_OPENAI_ENDPOINT,
)


def summarize_attachments(attachments: list[dict]) -> str:
    """
    attachments = list of dicts like:
    [
      {"file_name": "...pdf", "summary": "text..."},
      {"file_name": "...pdf", "summary": "text..."},
      ...
    ]

    We will:
    - use file_name + summary together
    - let the model infer what type of document it is (ACORD, Loss Run, SOV, etc.)
    - create ONE combined commercial insurance submission summary
    """

    # Build a compact text block with all attachments
    # (you can adjust the length limit if needed)
    attachment_chunks = []
    for item in attachments:
        file_name = item.get("file_name", "unknown_file")
        summary_text = item.get("summary", "")

        chunk = f"FILENAME: {file_name}\nSUMMARY: {summary_text}"
        attachment_chunks.append(chunk)

    attachments_text = "\n\n".join(attachment_chunks)
    attachments_text = attachments_text[:8000]  # simple safety limit

    prompt = f"""
You are an experienced Commercial Insurance Underwriter.

You are given multiple attachment documents that belong to a SINGLE
commercial insurance submission. For each document you only see:
- the file name (which hints at document type, e.g. ACORD app, loss run, SOV)
- a short summary of the contents.

YOUR TASK:
Produce ONE combined "Submission Summary" for the account that synthesizes
all the information across all documents.

VERY IMPORTANT RULES:
1. Treat the file names and their summaries as the ONLY source of truth.
   - You may use the file name to infer the general document type
     (e.g. application, loss runs, SOV, schedule).
   - Do NOT invent any new facts that are not clearly supported by
     the summaries.
2. Do NOT mention which document or file any detail came from.
   - The final summary must read like a single coherent view of the account,
     not a list of separate documents.
3. Focus on underwriting-relevant information, such as:
   - Named insured / client
   - Locations and occupancy
   - Operations / business activities
   - Coverage dates and basic program structure
   - Property values / limits / coinsurance (if mentioned)
   - Key coverage features (causes of loss, notable exclusions)
   - Loss history and major incidents
   - Any other material hazards or special notes that appear in the summaries.

STRUCTURE OF YOUR OUTPUT:
- Start with a heading line: "SUBMISSION SUMMARY"
- Then write 2–4 short sections with clear headings in ALL CAPS, for example:
  - ACCOUNT OVERVIEW
  - PROPERTY & COVERAGE DETAILS
  - LOSS HISTORY
  - OTHER NOTABLE POINTS
- You may choose different section names if they better fit the information.
- Inside each section, write 1–3 concise sentences in natural prose.
- Do NOT use bullet points unless they are clearly helpful.
- Do NOT mention file names, document types, or say that you are summarizing attachments.

GENERAL WRITING RULES:
- Only include details that are explicitly present or clearly implied
  by the summaries.
- Do NOT comment on missing or unknown information.
- Do NOT guess at submission status (e.g. new business vs renewal)
  unless that exact wording appears in the summaries.
- Use a professional, concise underwriting tone.

ATTACHMENT SUMMARIES (file name followed by its summary):

\"\"\" 
{attachments_text}
\"\"\"
    """

    response = client.chat.completions.create(
        model=AZURE_OPENAI_CHAT_DEPLOYMENT,
        messages=[{"role": "user", "content": prompt}],
        max_tokens=512,
        temperature=0.2,
    )

    try:
        return response.choices[0].message.content.strip()
    except Exception:
        return getattr(response.choices[0].message, "content", "").strip()


if __name__ == "__main__":
    # Absolute path to this file's folder (NewSummary)
    base_dir = os.path.dirname(os.path.abspath(__file__))

    output_folder = "output"

    # (Optional) If you still want to directly inspect the JSON file:
    json_path = os.path.join(base_dir, output_folder, "layout_summaries_result.json")
    with open(json_path, "r", encoding="utf-8") as f:
        layout_json = json.load(f)
    # print(layout_json)  # just for debugging if needed

    # 1) Use your existing helper to extract file_name + summary pairs
    filenamesummary_extracted_beautified = extract_filenames_and_summaries(output_folder)
    print("Per-document summaries:")
    print(filenamesummary_extracted_beautified)

    # 2) Call the new summariser to get ONE combined submission summary
    combined_summary = summarize_attachments(filenamesummary_extracted_beautified)

    # 3) Print the combined summary
    print("\n================ COMBINED SUBMISSION SUMMARY ================\n")
    print(combined_summary)
