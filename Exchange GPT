from dotenv import load_dotenv
import os
import json
from openai import AzureOpenAI  # Correct import for Azure OpenAI

# Load environment variables
load_dotenv()

AZURE_OPENAI_ENDPOINT = os.getenv("AZURE_OPENAI_ENDPOINT")
AZURE_OPENAI_API_VERSION = os.getenv("AZURE_OPENAI_API_VERSION")
AZURE_OPENAI_API_KEY = os.getenv("AZURE_OPENAI_API_KEY")
AZURE_OPENAI_CHAT_DEPLOYMENT = os.getenv("AZURE_OPENAI_CHAT_DEPLOYMENT")

if not (
    AZURE_OPENAI_ENDPOINT
    and AZURE_OPENAI_API_VERSION
    and AZURE_OPENAI_API_KEY
    and AZURE_OPENAI_CHAT_DEPLOYMENT
):
    raise RuntimeError(
        "Azure OpenAI env vars missing. Please set "
        "AZURE_OPENAI_ENDPOINT, AZURE_OPENAI_API_VERSION, "
        "AZURE_OPENAI_API_KEY and AZURE_OPENAI_CHAT_DEPLOYMENT"
    )

# Create Azure OpenAI client
client = AzureOpenAI(
    api_key=AZURE_OPENAI_API_KEY,
    api_version=AZURE_OPENAI_API_VERSION,
    azure_endpoint=AZURE_OPENAI_ENDPOINT,
)


def summarize_first_page(document_json: dict, file_name: str | None = None) -> str:
    """
    Now this function summarizes a JSON document (extracted fields),
    NOT a 'first page of text'.

    document_json is expected to be the parsed JSON dict, for example:
    {
      "General Information": { ... },
      "Policy Information": { ... },
      ...
    }
    """

    # Safety: limit JSON size in the prompt (optional)
    # If JSON is huge, you can trim some sections or keys before dumping.
    json_string = json.dumps(document_json, indent=2)
    json_string = json_string[:6000]  # simple safety limit

    prompt = f"""
You are an experienced Commercial Insurance Underwriter.

You are given structured JSON data extracted from an insurance form.
Each value may sometimes include a trailing text like ", confidence - 0.974".
Ignore this confidence part when understanding the business meaning.

Using ONLY the information in this JSON, write a short underwriting-focused
summary as ONE paragraph of 4â€“6 sentences.

Requirements:
- Be objective, clear, and concise.
- Do NOT invent any information that is not explicitly present in the JSON.
- Do NOT mention JSON, keys, fields, or document structure.
- Do NOT use bullet points or numbered lists.
- If some common underwriting details (e.g. limits, policy dates, operations) are missing, simply do not mention them.
- In the paragraph, make important labels **bold**, such as **Insured Name**, **Policy Number**, **Policy Effective Date**, **Agency**, **Carrier**, **Operations**, **Location**, etc., when those details exist in the JSON.

Here is the JSON data to summarise:
{json_string}
    """

    response = client.chat.completions.create(
        model=AZURE_OPENAI_CHAT_DEPLOYMENT,
        messages=[{"role": "user", "content": prompt}],
        max_tokens=256,
        temperature=0.2,
    )

    try:
        return response.choices[0].message.content.strip()
    except Exception:
        return getattr(response.choices[0].message, "content", "").strip()


if __name__ == "__main__":
    # This block will:
    # 1) find the JSON file under NewSummary/input/
    # 2) load it
    # 3) call summarize_first_page(document_json)
    # 4) print the summary

    # Absolute path to this file's folder (NewSummary)
    base_dir = os.path.dirname(os.path.abspath(__file__))

    # Path to the JSON inside the input folder
    json_path = os.path.join(base_dir, "input", "form_output.json")
    #   ^ change "form_output.json" to your actual file name

    # Load JSON from file
    with open(json_path, "r", encoding="utf-8") as f:
        document_json = json.load(f)

    # Call the summariser
    summary = summarize_first_page(document_json, file_name="form_output.json")

    # Print summary to console
    print(summary)
