now here as we are giving attachment_text in pronmpt i want to pass reference number to newsummary.py maybe we can create a new function here which accepts the reference number from where i am not sure we should call this new function, 
and that new function will store that txt content in a variable so that we can pass that variable in the prompt along with attachment_text and one simple addition in prompt is that we have to tell llm to 
mention that email body in the summary such that it should be included in the template wherever it feels to include it in the section of the template 

for eg this is inside the body_<referencenumber>.txt that got downloaded in the email_body folder
here are sample txt files

first file
Dear Underwriting Team,
I am submitting HighTech Solution for your consideration for Business Interruption coverage. High Tech Solution operates in the Technology / Software Services sector and seeks a 12-month policy effective January 1, 2026 through January 1, 2027. The requested limit is $50,000,000 excess of $15,000,000, and the Total Insured Value is $900,000,000.
The insured’s mailing address is High Tech Solution, 456 Elm St, Suite 200, Los Angeles, CA 90001, USA. Enclosed with this submission are the Acord 125, Schedule of Values (SOV), and Loss Run for your review.
Please confirm receipt of the submission and advise if you require any further underwriting information, valuation backup, or clarification on exposures. I appreciate your prompt attention and look forward to your feedback.
Best regards,
William Grey
Prime Brokers



second file
Please find ACORD 125 and the Loss details (Excel) attached for a property
submission on behalf of Sunflower Property Group LLC (dba Cruise Mall). We
request your review and underwriting feedback to confirm appetite, capacity
and any outstanding requirements to progress placement.



| Item | Details |

|---|---|

| Named insured | Sunflower Property Group LLC (dba Cruise Mall) |

| Location | Dockside Plaza, 210 Oceanfront Lane, Seabreeze, FL 33107 |

| Line requested | Property — Building, Business Personal Property,
Business Interruption (incl. Extra Expense) |

| Requested effective date | 2026-02-01 |

| Building limit requested | $120,000,000 |

| Contents limit requested | $15,000,000 |

| Business Interruption limit requested | $40,000,000; Indemnity period: 24
months |

| Deductible preference | $100,000 standard; provide hurricane/wind
sublimit options |

| Construction / Year built | Type II (non-combustible) / 2012 (major
renovations 2019) |

| Occupancy | Mixed-use resort retail and food & beverage |

| Protective features | Full sprinkler system; central station alarm;
hydrant within 300 ft |

| Annual gross revenue | $55,000,000 |

| Attachments | ACORD 125; Loss details (Excel) |

Requested underwriting feedback

- Confirm appetite and available capacity for the proposed property program
including BI limit requested

- Preferred valuation basis (Replacement Cost vs. Agreed Value) and
endorsement options for ordinance/law and soft costs

- Deductible options and sublimits for named windstorm, flood and ordinance
coverage

- Any immediate underwriting requirements (ACORD property supplements,
current valuation reports, recent engineering/inspection reports, proof of
protective devices, loss history)

- Preferred secure channel to receive additional documents



Thank you for your prompt review. I look forward to your guidance on next
steps.



Kind regards,

Olivia Park

Senior Hospitality Broker u{2014} Meridian Shoreline Insurance Partners

olivia.park@meridianship.com

+1 (555) 214-7802


etc 


so if llm feels to include this infromation which is only the main content of mail and not the top and bottom part which top( from file one ->Dear Underwriting Team,, from file 2 bottom part ->Kind regards,

Olivia Park

Senior Hospitality Broker u{2014} Meridian Shoreline Insurance Partners

olivia.park@meridianship.com

+1 (555) 214-7802)
so basically focusing on main important content of mail and including it in the summary in any section that llm feels that it should include it 

newsummary.py

from dotenv import load_dotenv
import os
import json
from Data_Filler import extract_filenames_and_summaries
from Data_Filler import connect_to_blob, beautify_extracted_data
from openai import AzureOpenAI  # Correct import for Azure OpenAI

# Load environment variables
load_dotenv()

AZURE_OPENAI_ENDPOINT = os.getenv("AZURE_OPENAI_ENDPOINT")
AZURE_OPENAI_API_VERSION = os.getenv("AZURE_OPENAI_API_VERSION")
AZURE_OPENAI_API_KEY = os.getenv("AZURE_OPENAI_API_KEY")
AZURE_OPENAI_CHAT_DEPLOYMENT = os.getenv("AZURE_OPENAI_CHAT_DEPLOYMENT")

if not (
    AZURE_OPENAI_ENDPOINT
    and AZURE_OPENAI_API_VERSION
    and AZURE_OPENAI_API_KEY
    and AZURE_OPENAI_CHAT_DEPLOYMENT
):
    raise RuntimeError(
        "Azure OpenAI env vars missing. Please set "
        "AZURE_OPENAI_ENDPOINT, AZURE_OPENAI_API_VERSION, "
        "AZURE_OPENAI_API_KEY and AZURE_OPENAI_CHAT_DEPLOYMENT"
    )

# Create Azure OpenAI client
client = AzureOpenAI(
    api_key=AZURE_OPENAI_API_KEY,
    api_version=AZURE_OPENAI_API_VERSION,
    azure_endpoint=AZURE_OPENAI_ENDPOINT,
)



I think we need a funciton something like this to get the reference number we will call this function from summary_handler.py I think we did this earlier to download the body.txt also and then we will pass this reference number to the below function and add the logic in below function of getting that particular file using reference number and passing it in the prompt
def getreference_number(beautify_data:list):
       # collect unique references
    refs = set()
    for item in beautified_data or []:
        ref = item.get("reference_number") or item.get("reference") or None
        if ref:
            refs.add(str(ref))

    if not refs:
        return {"status": "no_refs", "message": "No reference numbers found in beautified_data", "details": {}}





def summarize_attachments(attachments: list[dict]) -> str:
    """
    attachments = list of dicts like:
    [
      {"file_name": "...pdf", "summary": "text...", "text": "full doc text"},
      ...
    ]
    Only 'summary' is used here.
    """
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))
    INPUT_FOLDER = os.path.join(BASE_DIR, "email_body")

    attachment_chunks = []
    for item in attachments:
        file_name = item.get("file_name", "unknown_file")
        summary_text = item.get("summary", "")

        chunk = f"FILENAME: {file_name}\nSUMMARY: {summary_text}"
        attachment_chunks.append(chunk)

    attachments_text = "\n\n".join(attachment_chunks)
    attachments_text = attachments_text[:8000]  # simple safety limit

    prompt = f"""
You are an experienced Commercial Insurance Underwriter.

You are given multiple attachment documents that belong to a SINGLE
commercial insurance submission. For each document you only see:
- the file name (which hints at document type, e.g. ACORD app, loss run, SOV)
- a short summary of the contents.

YOUR TASK:
Produce ONE combined "Submission Summary" for the account that synthesizes
all the information across all documents.

VERY IMPORTANT RULES:
1. Treat the file names and their summaries as the ONLY source of truth.
   - You may use the file name to infer the general document type
     (e.g. application, loss runs, SOV, schedule).
   - Do NOT invent any new facts that are not clearly supported by
     the summaries.
2. Do NOT mention which document or file any detail came from.
   - The final summary must read like a single coherent view of the account,
     not a list of separate documents.
3. Focus on underwriting-relevant information, such as:
   - Named insured / client
   - Locations and occupancy
   - Operations / business activities
   - Coverage dates and basic program structure
   - Property values / limits / coinsurance (if mentioned)
   - Key coverage features (causes of loss, notable exclusions)
   - Loss history and major incidents
   - Any other material hazards or special notes that appear in the summaries.

STRUCTURE OF YOUR OUTPUT (USE THIS EXACT TEMPLATE):

SUBMISSION SUMMARY  
Client: [Client Legal Name]  
Date: [Submission or Document Date]

1. SUBMISSION COVER LETTER / NARRATIVE  
 Exposure Description:  
    - [Describe what the business does]  
    - [Main operations / physical activities]  
    - [Property details: construction, age, protection, sprinklers, etc.]  

 Placement Strategy:  
    - [Placement goals or program approach if evident]  

 Renewal Highlights:  
    - [Notable changes or updates if mentioned]  

 Changes YOY:  
    - [Any changes in exposure, values, operations, or loss experience]  

 Additional Overview Details:  
    - Effective Date: [Coverage start date]  
    - Submission Type: [Renewal / New Business / Other]  
    - Current Situation: [Reason for submission if stated]  

2. LOSS HISTORY PACKAGE   
 5–10 Year Loss Runs:  
    - [Summarize multi-year loss experience if available]  

 Large Loss Details:  
    - [Brief details on significant claims]  

 Trends Analysis:  
    - [Patterns in frequency/severity if evident]  

 Summary of Loss History:  
    - Status: [Clean / Losses Reported]  
    - Summary: [1-sentence overview]  
    - Major Incidents: [Largest incident if present]  

3. EXPOSURE DATA  
 COPE Information (Construction, Occupancy, Protection, Exposure):  
    - [Building info, occupancy, protection systems]  

 Statement of Values (SOV):  
    - Total Insurable Value (TIV): $[Insert]  
    - Building Limit: $[Insert]  
    - Contents/BPP Limit: $[Insert]  
    - Business Income: $[Insert]  

 Financials:  
    - [Any financial information if mentioned]  

 CAT Worksheets:  
    - [If any catastrophe/hazard info appears]  

 Specialty Schedules:  
    - [Any special schedules referenced]  

 Additional Exposure Details:  
    - Total Locations: [Insert]  
    - Main Operations: [Insert]  
    - Property Details: [Insert]  
    - Deductible Requested: $[Insert]  

4. RISK REPORTS  
 Engineering Surveys:  
    - [If referenced]  

 Safety Audits:  
    - [If referenced]  

5. COMPLIANCE DOCUMENTS  
 Signed Application Forms  
 Declarations  
 Warranties & Indemnities  

 Attached Files Included in the Submission:  
    - [List packaged documents, e.g., application, loss runs, SOV]  


ATTACHMENT SUMMARIES (file name followed by its summary):

\"\"\" 
{attachments_text}
\"\"\"
    """

    response = client.chat.completions.create(
        model=AZURE_OPENAI_CHAT_DEPLOYMENT,
        messages=[{"role": "user", "content": prompt}],
        max_tokens=512,
        temperature=0.2,
    )

    try:
        return response.choices[0].message.content.strip()
    except Exception:
        return getattr(response.choices[0].message, "content", "").strip()
